#!/bin/bash
# SOAR Platform Monitoring Script
# Generated by Ansible - deploy_soar_platform role

set -e

DEPLOY_DIR="{{ soar_deploy_dir }}"
cd "${DEPLOY_DIR}"

echo "=================================="
echo "SOAR Platform Status Monitor"
echo "=================================="
echo ""

# Container Status
echo "Container Status:"
docker compose ps
echo ""

# Resource Usage
echo "Resource Usage:"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" $(docker compose ps -q)
echo ""

# Service Health Checks
echo "Service Health Checks:"

# PostgreSQL
if docker compose exec -T postgres pg_isready -U {{ soar_postgres_user }} > /dev/null 2>&1; then
    echo "✓ PostgreSQL: Healthy"
else
    echo "✗ PostgreSQL: Unhealthy"
fi

# Redis
if docker compose exec -T redis redis-cli ping | grep -q PONG; then
    echo "✓ Redis: Healthy"
else
    echo "✗ Redis: Unhealthy"
fi

# n8n
if curl -sf http://localhost:5678/healthz > /dev/null 2>&1; then
    echo "✓ n8n: Healthy"
else
    echo "✗ n8n: Unhealthy or not responding"
fi

# Nginx
if curl -sfk https://localhost > /dev/null 2>&1; then
    echo "✓ Nginx: Responding"
else
    echo "✗ Nginx: Not responding"
fi

echo ""
echo "Database Statistics:"
docker compose exec -T postgres psql -U {{ soar_postgres_user }} -d {{ soar_postgres_db }} -c "SELECT schemaname, tablename, n_tup_ins as inserts, n_tup_upd as updates FROM pg_stat_user_tables ORDER BY n_tup_ins DESC LIMIT 5;" 2>/dev/null || echo "Unable to fetch database stats"

echo ""
echo "Recent Logs (last 10 lines per service):"
echo "========================================"
docker compose logs --tail=10

echo ""
echo "Quick Commands:"
echo "  View live logs: docker compose logs -f"
echo "  Restart n8n: docker compose restart apksoar"
echo "  Backup data: ./backup.sh"
echo "  Stop all: docker compose down"
