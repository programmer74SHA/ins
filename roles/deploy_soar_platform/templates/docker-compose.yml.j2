version: "3.8"
volumes:
  db_storage:
  apksoar_storage:
  redis_storage:
x-shared: &shared
  restart: always
  image: {{ soar_n8n_image }}
  environment:
    - N8N_LICENSE_TOKEN=${license_key}
    - WEB_DRIVER_URL=web_driver
    - WEB_DRIVER_PORT=4444
#    - TZ=${TIMEZONE}
    - DB_TYPE=postgresdb
    - DB_POSTGRESDB_HOST=postgres
    - DB_POSTGRESDB_PORT=5432
    - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
    - DB_POSTGRESDB_USER=${POSTGRES_USER}
    - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
    - EXECUTIONS_MODE=queue
    - QUEUE_BULL_REDIS_HOST=redis
    - QUEUE_HEALTH_CHECK_ACTIVE=true
#    - GENERIC_TIMEZONE=${TIMEZONE}
    - N8N_PERSONALIZATION_ENABLED=false
    - WEBHOOK_URL=https://${APKSOAR_HOST}/
    - N8N_HOST=${APKSOAR_HOST}
    - VUE_APP_URL_BASE_API=https://${APKSOAR_HOST}/
    - N8N_PROTOCOL=https
    - N8N_DIAGNOSTICS_ENABLED=false
    - N8N_VERSION_NOTIFICATIONS_ENABLED=false
    - N8N_TEMPLATES_ENABLED=false
    - N8N_PROXY_HOPS=1
    - NODES_EXCLUDE=["n8n-nodes-base.executeCommand", "n8n-nodes-base.readWriteFile"]
    - N8N_LOG_OUTPUT=console,file
    - DB_LOGGING_ENABLED=true
    - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    - N8N_RUNNERS_ENABLED=true
    - N8N_RUNNERS_MODE=internal
    - N8N_CUSTOM_EXTENSIONS=/home/node/apk
    - GENERIC_TIMEZONE={{ soar_timezone }}
    - TZ={{ soar_timezone }}
  links:
    - postgres
    - redis
  volumes:
    - apksoar_storage:/home/node/.n8n
    - ./n8n-nodes:/home/node/apk
  healthcheck:
    test:
      [
        "CMD",
        "sh",
        "-c",
        '(wget -q -T 5 -O - http://localhost:5678/healthz 2>/dev/null | grep -qF ''{"status":"ok"}'') || exit 1',
      ]
    interval: 15s
    timeout: 10s
    retries: 3
    start_period: 1m00s
  depends_on:
    redis:
      condition: service_healthy
    postgres:
      condition: service_healthy
  networks:
    - {{ soar_network_name }}
services:
  postgres:
    image: {{ soar_postgres_image }}
    restart: always
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
    volumes:
      - db_storage:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - {{ soar_network_name }}
  redis:
    image: {{ soar_redis_image }}
    restart: always
    environment:
      - GENERIC_TIMEZONE={{ soar_timezone }}
      - TZ={{ soar_timezone }}
    volumes:
      - redis_storage:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - {{ soar_network_name }}
  apksoar:
    <<: *shared
    container_name: "apksoar-main"
    ports:
      - "127.0.0.1:5678:5678"
  apksoar-worker:
    <<: *shared
    command: worker
    container_name: "apksoar-worker"
    depends_on:
      - apksoar
  nginx:
    image: {{ soar_nginx_image }}
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=${TIMEZONE}
    volumes:
      - ./nginx-data/nginx_logs:/var/log/nginx
      - ./nginx-data/ssl_certs:/certs
      - ./nginx.conf:/etc/nginx/nginx.conf
    networks:
      - {{ soar_network_name }}
    depends_on:
      - apksoar
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -kf https://localhost || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 3
      start_period: 10s
  web_driver:
    profiles: ["web_driver"]
    restart: always
    image: {{ soar_web_driver_image }}
    ports:
      - "127.0.0.1:4444:4444"
    shm_size: "2gb"
    container_name: "web_driver"
    networks:
      - {{ soar_network_name }}
networks:
  {{ soar_network_name }}:
{% if soar_network_external %}
    external: true
    name: {{ soar_network_name }}
{% endif %}
