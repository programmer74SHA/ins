#!/bin/bash
# SOAR Platform Backup Script
# Generated by Ansible - deploy_soar_platform role

set -e

BACKUP_DIR="{{ soar_backup_dir | default(soar_deploy_dir ~ '/backups') }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="soar_backup_${TIMESTAMP}"

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

echo "Starting backup: ${BACKUP_NAME}"

# Backup PostgreSQL database
echo "Backing up PostgreSQL database..."
docker compose exec -T postgres pg_dump -U {{ soar_postgres_user }} {{ soar_postgres_db }} > "${BACKUP_DIR}/${BACKUP_NAME}_postgres.sql"

# Backup n8n data
echo "Backing up n8n data..."
tar -czf "${BACKUP_DIR}/${BACKUP_NAME}_n8n_data.tar.gz" -C {{ soar_deploy_dir }} n8n-data

# Backup Redis data
echo "Backing up Redis data..."
docker compose exec -T redis redis-cli save
tar -czf "${BACKUP_DIR}/${BACKUP_NAME}_redis_data.tar.gz" -C {{ soar_deploy_dir }} redis-data

# Backup configuration files
echo "Backing up configuration files..."
tar -czf "${BACKUP_DIR}/${BACKUP_NAME}_configs.tar.gz" \
    -C {{ soar_deploy_dir }} \
    docker-compose.yml \
    .env \
    nginx.conf \
    template

# Create backup manifest
cat > "${BACKUP_DIR}/${BACKUP_NAME}_manifest.txt" << EOF
Backup Timestamp: ${TIMESTAMP}
PostgreSQL Backup: ${BACKUP_NAME}_postgres.sql
n8n Data Backup: ${BACKUP_NAME}_n8n_data.tar.gz
Redis Data Backup: ${BACKUP_NAME}_redis_data.tar.gz
Configuration Backup: ${BACKUP_NAME}_configs.tar.gz
EOF

echo "Backup completed successfully: ${BACKUP_DIR}/${BACKUP_NAME}"

# Clean up old backups (keep last {{ soar_backup_retention_days | default(30) }} days)
echo "Cleaning up old backups..."
find "${BACKUP_DIR}" -name "soar_backup_*" -type f -mtime +{{ soar_backup_retention_days | default(30) }} -delete

echo "Backup process finished"
