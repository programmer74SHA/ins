#!/bin/bash
# Smart Analyzer Monitoring Script
# Generated by Ansible - deploy_smart_analyzer role

set -e

DEPLOY_DIR="{{ smart_analyzer_deploy_dir }}"
cd "${DEPLOY_DIR}"

echo "=================================="
echo "Smart Analyzer Status Monitor"
echo "=================================="
echo ""

# Container Status
echo "Container Status:"
docker compose ps
echo ""

# Resource Usage
echo "Resource Usage:"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" $(docker compose ps -q)
echo ""

# GPU Status (if available)
if command -v nvidia-smi &> /dev/null; then
    echo "GPU Status:"
    nvidia-smi --query-gpu=index,name,temperature.gpu,utilization.gpu,utilization.memory,memory.used,memory.total --format=csv
    echo ""
fi

# Service Health Checks
echo "Service Health Checks:"

# AI Service
if curl -sf http://localhost:{{ smart_analyzer_ai_service_port }}/health > /dev/null 2>&1; then
    echo "✓ AI Service: Healthy"
else
    echo "✗ AI Service: Unhealthy or not responding"
fi

# Qdrant
if curl -sf http://localhost:{{ smart_analyzer_qdrant_port }}/health > /dev/null 2>&1; then
    echo "✓ Qdrant: Healthy"
else
    echo "✗ Qdrant: Unhealthy or not responding"
fi

# HAProxy
if curl -sf http://localhost:{{ smart_analyzer_haproxy_port }}/ > /dev/null 2>&1; then
    echo "✓ HAProxy: Responding"
else
    echo "✗ HAProxy: Not responding"
fi

echo ""
echo "Recent Logs (last 10 lines per service):"
echo "========================================"
docker compose logs --tail=10

echo ""
echo "To view live logs: docker compose logs -f"
echo "To restart services: docker compose restart"
echo "To stop services: docker compose down"
