#!/bin/bash
# Secret Management Backup Script
# Generated by Ansible - deploy_secret_management role

set -e

BACKUP_DIR="{{ secret_management_backup_dir }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="secret_mgmt_backup_${TIMESTAMP}"

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

echo "Starting backup: ${BACKUP_NAME}"

# Backup PostgreSQL database
echo "Backing up PostgreSQL database..."
docker exec postgres pg_dump -U {{ secret_management_postgres_user }} {{ secret_management_postgres_db }} > "${BACKUP_DIR}/${BACKUP_NAME}_postgres.sql"

# Backup Vault data
echo "Backing up Vault storage..."
tar -czf "${BACKUP_DIR}/${BACKUP_NAME}_vault_storage.tar.gz" -C {{ secret_management_deploy_dir }}/vault storage

# Backup configuration files
echo "Backing up configuration files..."
tar -czf "${BACKUP_DIR}/${BACKUP_NAME}_configs.tar.gz" \
    -C {{ secret_management_deploy_dir }} \
    docker-compose.yml \
    .env \
    vault/config

# Create backup manifest
cat > "${BACKUP_DIR}/${BACKUP_NAME}_manifest.txt" << EOF
Backup Timestamp: ${TIMESTAMP}
PostgreSQL Backup: ${BACKUP_NAME}_postgres.sql
Vault Storage Backup: ${BACKUP_NAME}_vault_storage.tar.gz
Configuration Backup: ${BACKUP_NAME}_configs.tar.gz
EOF

echo "Backup completed successfully: ${BACKUP_DIR}/${BACKUP_NAME}"

# Clean up old backups (keep last {{ secret_management_backup_retention_days }} days)
echo "Cleaning up old backups..."
find "${BACKUP_DIR}" -name "secret_mgmt_backup_*" -type f -mtime +{{ secret_management_backup_retention_days }} -delete

echo "Backup process finished"
