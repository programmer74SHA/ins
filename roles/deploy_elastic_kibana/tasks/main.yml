---
# ELK Stack deployment tasks

- name: Ensure deployment directory exists
  ansible.builtin.file:
    path: "{{ elk_deploy_dir }}"
    state: directory
    mode: '0755'

- name: Ensure certs directory exists
  ansible.builtin.file:
    path: "{{ elk_deploy_dir }}/certs"
    state: directory
    mode: '0755'

- name: Copy certificate generation script
  ansible.builtin.copy:
    src: generate_cert.sh
    dest: "{{ elk_deploy_dir }}/generate_cert.sh"
    mode: '0755'

- name: Copy indices setup script
  ansible.builtin.copy:
    src: indice.sh
    dest: "{{ elk_deploy_dir }}/indice.sh"
    mode: '0755'

- name: Generate certificates for customer
  ansible.builtin.command:
    cmd: "./generate_cert.sh {{ elk_customer_name }}"
    chdir: "{{ elk_deploy_dir }}"
    creates: "{{ elk_deploy_dir }}/certs/{{ elk_customer_name }}/cert.pem"
  register: cert_generation

- name: Display certificate generation output
  ansible.builtin.debug:
    var: cert_generation.stdout_lines
  when: cert_generation.changed

- name: Create docker network
  community.docker.docker_network:
    name: "{{ elk_network_name }}"
    state: present
  when: elk_network_external

- name: Template docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ elk_deploy_dir }}/docker-compose.yml"
    mode: '0644'
  notify: Restart ELK stack

- name: Template .env file
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ elk_deploy_dir }}/.env"
    mode: '0644'
  notify: Restart ELK stack

- name: Load elasticsearch docker image
  include_tasks: load-docker-image.yml

- name: Deploy ELK stack with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ elk_deploy_dir }}"
    state: present
    pull: never
    wait: false
  register: elk_deployment

- name: Wait for Elasticsearch container to be running
  ansible.builtin.command:
    cmd: docker inspect -f {% raw %}'{{.State.Running}}'{% endraw %} elasticsearch
  register: es_running
  until: es_running.stdout == 'true'
  retries: 30
  delay: 5
  changed_when: false

- name: Auto-generate temporary Elasticsearch password
  ansible.builtin.command:
    cmd: >
      docker exec elasticsearch
      /usr/share/elasticsearch/bin/elasticsearch-reset-password
      -u elastic
      -b
      -a
  register: auto_password_result
  changed_when: true
  failed_when: auto_password_result.rc != 0

- name: Extract auto-generated password
  ansible.builtin.set_fact:
    temp_elastic_password: "{{ auto_password_result.stdout | regex_search('New value: (.+)', '\\1') | first }}"

- name: Display auto-generated password (for debugging)
  ansible.builtin.debug:
    msg: "Auto-generated temporary password: {{ temp_elastic_password }}"

- name: Set final Elasticsearch password via REST API
  ansible.builtin.uri:
    url: "{{ elk_es_protocol }}://{{ elk_es_host }}/_security/user/elastic/_password"
    method: POST
    user: "elastic"
    password: "{{ temp_elastic_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      password: "{{ elk_elasticsearch_password }}"
    status_code: 200
  register: password_change_result

- name: Display password change result
  ansible.builtin.debug:
    msg: "Password successfully changed to configured value"
  when: password_change_result.status == 200

- name: Wait for Elasticsearch to be healthy
  ansible.builtin.uri:
    url: "{{ elk_es_protocol }}://{{ elk_es_host }}/_cluster/health"
    method: GET
    user: "{{ elk_es_user }}"
    password: "{{ elk_elasticsearch_password }}"
    force_basic_auth: yes
    status_code: 200
  register: es_health
  until: es_health.status == 200
  retries: 30
  delay: 10
  when: elk_setup_indices

- name: Run indices setup script
  ansible.builtin.command:
    cmd: "./indice.sh"
    chdir: "{{ elk_deploy_dir }}"
  register: indices_setup
  when: elk_setup_indices
  changed_when: true

- name: Display indices setup output
  ansible.builtin.debug:
    var: indices_setup.stdout_lines
  when: elk_setup_indices and indices_setup.changed
