#!/bin/bash
set -e
AI_VERSION=0.0.1
INSTALLER_TMP_PATH="/var/ai/tmp/installer"
LOCAL_REPOSITORY_DESTINATION_PATH="$INSTALLER_TMP_PATH/repository"
INSTALLER_PATH=$(pwd)
INVENTORY_FILE_NAME="inventory.ini"
SSH_KEY_PATH="$HOME/.ssh/id_rsa"
LOCAL_REPOSITORY_ARCHIVE_FILE_PATH="roles/deploy_apt_repository/files"
LOCAL_REPOSITORY_ARCHIVE_FILE_NAME="repo.tar.gz"
LOCAL_REPOSITORY_DIRECTORY_NAME="repository"

function RedLinePrinter() {
    echo -e "\033[31;40m $1 \033[0m"
}

function YellowLinePrinter() {
    echo -e "\033[7;49;93m $1 \033[0m"
}

function GreenLinePrinter() {
    echo -e "\033[32;40m $1 \033[0m"
}

function separator() {
    echo -e '\033[36;40m ******************************************************************\033[0m'
}

function PStatus() {
    if [ $? == 0 ]; then
        echo -e '\033[32;40m ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ \033[0m'
        echo -e "\033[32;40m $1 \033[0m"
        echo -e '\033[32;40m ============================================ \033[0m'
    else
        echo -e '\033[31;40m ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ \033[0m'
        echo -e "\033[31;40m !!!!!!!!______ $2 ______!!!!!!! \033[0m"
        echo -e '\033[31;40m ============================================ \033[0m'
        break
    fi
}

if [[ $EUID -ne 0 ]]; then
    RedLinePrinter "This installer must be run as root"
    exit 1
fi

function Helper() {
    GreenLinePrinter "Now you can configure your Ansible and START it to install AI V$AI_VERSION"
}

function START() {
    GreenLinePrinter "START process ......"
    separator
}

function CreateDirectory() {
    DirectoryPath=$1
    mkdir -p $DirectoryPath
    PStatus "Directory was created" "Faild to create $DirectoryPath "
    chmod 0755 $DirectoryPath
    PStatus "Permision Configured" "Faild to set permision on  $DirectoryPath "
}

function COPY_REPOSITORY_ARCHIVE_FILE() {
    YellowLinePrinter "Prepare local repository..."
    CreateDirectory $INSTALLER_TMP_PATH
    CreateDirectory $LOCAL_REPOSITORY_DESTINATION_PATH

    # Copy repo.tar.gz to destination
    cp ${INSTALLER_PATH}/${LOCAL_REPOSITORY_ARCHIVE_FILE_PATH}/${LOCAL_REPOSITORY_ARCHIVE_FILE_NAME} ${LOCAL_REPOSITORY_DESTINATION_PATH}
    PStatus "Local repository archive copied" "Failed to copy repository file"

    separator
    YellowLinePrinter "Extract local repository from repo.tar.gz"
    tar -xzf ${LOCAL_REPOSITORY_DESTINATION_PATH}/${LOCAL_REPOSITORY_ARCHIVE_FILE_NAME} -C ${LOCAL_REPOSITORY_DESTINATION_PATH}
    PStatus "Local repository archive extracted" "Failed to extract local repository archive"

    # Ensure repository structure is correct (rename siem to ai if needed)
    if [ -d "${LOCAL_REPOSITORY_DESTINATION_PATH}/${LOCAL_REPOSITORY_DIRECTORY_NAME}/dists/siem" ]; then
        mv ${LOCAL_REPOSITORY_DESTINATION_PATH}/${LOCAL_REPOSITORY_DIRECTORY_NAME}/dists/siem ${LOCAL_REPOSITORY_DESTINATION_PATH}/${LOCAL_REPOSITORY_DIRECTORY_NAME}/dists/ai
        PStatus "Repository distribution renamed to 'ai'" "Failed to rename distribution"
    fi

    separator
}

function INSTALL_ANSIBLE_DEPENDENCIES() {
    YellowLinePrinter "Configure APT sources.list to use local repository from repo.tar.gz"

    # Configure local repository as APT source in sources.list
    # This uses the extracted repo.tar.gz as the local APT repository
    echo "deb [trusted=yes] file://${LOCAL_REPOSITORY_DESTINATION_PATH}/${LOCAL_REPOSITORY_DIRECTORY_NAME} ai main" > /etc/apt/sources.list
    PStatus "sources.list configured with local repository" "Failed to configure sources.list"

    YellowLinePrinter "Update APT cache from local repository"
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    PStatus "APT cache updated from local repository" "Failed to update APT cache"

    YellowLinePrinter "Install Ansible from local repository"
    # Install ansible and dependencies from the local repository (repo.tar.gz)
    apt-get -y --allow-downgrades \
      -o Dpkg::Options::="--force-confdef" \
      -o Dpkg::Options::="--force-confold" \
      install ansible

    PStatus "Ansible installed from local repository" "Failed to install Ansible"
    separator
}

function FINISH() {
    GreenLinePrinter "FINISH process ..."
    Helper
}

function COPY_SSH_ID() {
    YellowLinePrinter "Copy ssh key to destination hosts"
    while IFS= read -r line; do
        if [[ -z "$line" || $line == \#* ]]; then
            continue
        fi
        if [[ -z "$line" || $line == \[* ]]; then
            break
        fi
        HOST=$(echo $line | grep -oP 'ansible_host=\K\S+')
        USERNAME=$(echo $line | grep -oP 'ansible_user=\K\S+')
        PASSWORD=$(echo $line | grep -oP 'ansible_ssh_pass=\K\S+' | tr -d \'\")
        if [[ -z "$HOST" || $HOST == "localhost" ]]; then
            continue
        fi
        sshpass -p $PASSWORD ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub "$USERNAME@$HOST"
        SetupPythonModule $USERNAME $HOST &
    done <"$INVENTORY_FILE_NAME"
    wait
    separator
}

function SetupPythonModule() {
    # Create directory on remote host
    ssh $1@$2 mkdir -p ${LOCAL_REPOSITORY_DESTINATION_PATH} < /dev/null | tee -a /var/log/$2.log

    # Copy repo.tar.gz to remote host
    scp ${INSTALLER_PATH}/${LOCAL_REPOSITORY_ARCHIVE_FILE_PATH}/${LOCAL_REPOSITORY_ARCHIVE_FILE_NAME} $1@$2:${LOCAL_REPOSITORY_DESTINATION_PATH} < /dev/null | tee -a /var/log/$2.log

    # Extract repo.tar.gz on remote host
    ssh $1@$2 tar -xzf ${LOCAL_REPOSITORY_DESTINATION_PATH}/${LOCAL_REPOSITORY_ARCHIVE_FILE_NAME} -C ${LOCAL_REPOSITORY_DESTINATION_PATH} < /dev/null | tee -a /var/log/$2.log

    # Configure sources.list on remote host to use local repository and install ansible
    ssh $1@$2 bash -lc '
        set -e

        # Rename siem to ai if needed
        if [ -d "/var/ai/tmp/installer/repository/repository/dists/siem" ]; then
            mv /var/ai/tmp/installer/repository/repository/dists/siem /var/ai/tmp/installer/repository/repository/dists/ai
        fi

        # Configure sources.list to use local repository from repo.tar.gz
        echo "deb [trusted=yes] file:///var/ai/tmp/installer/repository/repository ai main" > /etc/apt/sources.list

        # Update APT cache from local repository
        export DEBIAN_FRONTEND=noninteractive
        apt-get update

        # Install ansible from local repository
        apt-get -y --allow-downgrades \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold" \
          install ansible
    ' < /dev/null | tee -a /var/log/$2.log
}

function CREATE_SSH_KEY() {
    YellowLinePrinter "Creating SSH key"
    : "${SSH_KEY_PATH:=$HOME/.ssh/id_rsa}"
    rm -f "$SSH_KEY_PATH" "$SSH_KEY_PATH.pub"
    ssh-keygen -t rsa -b 4096 -f "$SSH_KEY_PATH" -N ''
    separator
}

function CheckHostsAvailability() {
    YellowLinePrinter "Checking hosts availability..."
    local all_hosts_available=true

    while IFS= read -r line; do
        if [[ -z "$line" || $line == \#* ]]; then
            continue
        fi
        if [[ $line == \[* ]]; then
            continue
        fi
        HOST=$(echo "$line" | grep -oP 'ansible_host=\K\S+')
        USER=$(echo "$line" | grep -oP 'ansible_user=\K\S+')
        PASS=$(echo "$line" | grep -oP 'ansible_ssh_pass=\K\S+' | tr -d \'\")
        CONNECTION=$(echo "$line" | grep -oP 'ansible_connection=\K\S+')

        if [[ -z "$HOST" || "$HOST" == "localhost" ]]; then
            continue
        fi

        if [[ "$CONNECTION" == "local" ]]; then
            continue
        fi

        YellowLinePrinter "Checking connectivity to $HOST as $USER..."
        if sshpass -p "$PASS" ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no "$USER@$HOST" echo ok >/dev/null 2>&1; then
            GreenLinePrinter "$HOST is reachable."
        else
            RedLinePrinter "ERROR: $HOST is unreachable."
            all_hosts_available=false
        fi
    done < "$INVENTORY_FILE_NAME"

    if ! $all_hosts_available; then
        RedLinePrinter "One or more hosts are unreachable. Exiting."
        exit 1
    else
        GreenLinePrinter "All hosts are reachable. Proceeding..."
    fi
    separator
}

function MAIN() {
    START
    COPY_REPOSITORY_ARCHIVE_FILE
    INSTALL_ANSIBLE_DEPENDENCIES
    CheckHostsAvailability
    CREATE_SSH_KEY
    COPY_SSH_ID
    FINISH
}

MAIN
